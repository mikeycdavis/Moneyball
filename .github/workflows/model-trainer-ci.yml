name: Train Models and Test

on:
  push:
    branches:
      - develop
      - master
    # Skip workflow if only .NET or DB project changed
    paths-ignore:
      - '.github/workflows/dot-net-ci.yml'
      - 'badges/**'
      - 'Moneyball.API/**'
      - 'Moneyball.Core/**'
      - 'Moneyball.Database/**'
      - 'Moneyball.Infrastructure/**'
      - 'Moneyball.Tests/**'
  pull_request:
    branches:
      - develop
      - master
    # Skip workflow if only .NET or DB project changed
    paths-ignore:
      - '.github/workflows/dot-net-ci.yml'
      - 'badges/**'
      - 'Moneyball.API/**'
      - 'Moneyball.Core/**'
      - 'Moneyball.Database/**'
      - 'Moneyball.Infrastructure/**'
      - 'Moneyball.Tests/**'
  workflow_dispatch:  # Allow manual triggering
  schedule:
    # Run daily at 2 AM UTC to retrain models
    - cron: '0 2 * * *'

jobs:  
  build-python:
    name: Build Python
    runs-on: ubuntu-latest

    permissions:
      contents: write
      checks: write

    env:
      COVERAGE_THRESHOLD: 1
      COVERAGE_THRESHOLD_WARNING: 0

    strategy:
      matrix:
        python-version: ["3.12.x"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        working-directory: Moneyball.ML.Python
        run: |
          python -m pip install --upgrade pip setuptools wheel build
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt; 
          fi

      - name: Build package
        working-directory: Moneyball.ML.Python
        run: |
          python -m build

      - name: Run tests with coverage
        working-directory: Moneyball.ML.Python
        run: |
          pytest \
            --junitxml=../test-results.xml \
            --cov=. \
            --cov-report=xml:../coverage.xml \
            --cov-report=term

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Moneyball Python Tests (Py ${{ matrix.python-version }})
          path: test-results.xml
          reporter: java-junit

      - name: Show Coverage Summary
        run: cat coverage.xml

      - name: Enforce Coverage Threshold
        id: coverage
        run: |
          # Read from the root coverage.xml
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' coverage.xml | head -1)
          # Convert decimal (e.g., 0.86) to whole number (86)
          COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc | cut -d'.' -f1)
          echo "Line Coverage: $COVERAGE_PERCENT%"
          echo "coverage=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
          
          if [ "$COVERAGE_PERCENT" -lt "$COVERAGE_THRESHOLD" ]; then
            echo "Coverage $COVERAGE_PERCENT% is below threshold ($COVERAGE_THRESHOLD%)"
            exit 1
          fi

      - name: Set Badge Info
        if: matrix.python-version == '3.12.x' && (github.ref_name == 'master' || github.ref_name == 'develop')
        run: |
          if [ "${GITHUB_REF_NAME}" == "master" ]; then
            BADGE_FILE="badges/coverage-python-master.svg"
            BADGE_LABEL="master"
          else
            BADGE_FILE="badges/coverage-python-develop.svg"
            BADGE_LABEL="develop"
          fi

          echo "BADGE_FILE=$BADGE_FILE" >> $GITHUB_ENV
          echo "BADGE_LABEL=$BADGE_LABEL" >> $GITHUB_ENV

      - name: Set Badge Color
        if: matrix.python-version == '3.12.x'
        run: |
          if [ "${{ steps.coverage.outputs.coverage }}" -ge "$COVERAGE_THRESHOLD" ]; then
            COLOR="44cc11"
          elif [ "${{ steps.coverage.outputs.coverage }}" -ge "$COVERAGE_THRESHOLD_WARNING" ]; then
            COLOR="dfb317"
          else
            COLOR="e05d44"
          fi
          echo "BADGE_COLOR=$COLOR" >> $GITHUB_ENV

      - name: Generate Coverage Badge
        if: matrix.python-version == '3.12.x' && (github.ref_name == 'master' || github.ref_name == 'develop')
        uses: emibcn/badge-action@v2
        with:
          label: ${{ env.BADGE_LABEL }}
          status: ${{ steps.coverage.outputs.coverage }}%
          color: ${{ env.BADGE_COLOR }}
          path: ${{ env.BADGE_FILE }}

      - name: Commit Badge
        if: matrix.python-version == '3.12.x' && (github.ref_name == 'master' || github.ref_name == 'develop')
        uses: EndBug/add-and-commit@v9
        with:
          add: ${{ env.BADGE_FILE }}
          message: "chore: update python coverage badge"
          push: true
          default_author: github_actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: coverage.xml
  
  train:
    name: Train Models
    runs-on: ubuntu-latest
    needs: build-python
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        working-directory: Moneyball.ML.Python
        run: |
          python -m pip install --upgrade pip setuptools wheel build
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt; 
          fi
      
      - name: Create models directory
        working-directory: Moneyball.ML.Python
        run: |
          mkdir -p models
      
      # Acceptance Criteria: Execute python -m moneyball_ml_python.training.train
      - name: Train all models
        working-directory: Moneyball.ML.Python
        run: |
          python -m moneyball_ml_python.training.train
        env:
          PYTHONUNBUFFERED: 1
      
      - name: Verify models were created
        working-directory: Moneyball.ML.Python
        run: |
          echo "Models created:"
          ls -lh models/
          echo ""
          echo "Model count:"
          ls models/*.pkl 2>/dev/null | wc -l || echo "0"
      
      # Acceptance Criteria: Upload /models directory as build artifact
      - name: Upload trained models
        working-directory: Moneyball.ML.Python
        uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: models/
          retention-days: 30
      
      - name: Upload training logs
        working-directory: Moneyball.ML.Python
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: training-logs
          path: training.log
          retention-days: 7